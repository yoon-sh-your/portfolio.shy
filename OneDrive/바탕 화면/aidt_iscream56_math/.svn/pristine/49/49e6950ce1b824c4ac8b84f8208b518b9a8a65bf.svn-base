let boxContainer;
let r1;
let r2;
let count;
let w1;
let w2;
let w3;
let w4;
let wraps;

runAfterAppReady(function () {
    setting();





    // ì•± ì¤€ë¹„ í›„ ì‹¤í–‰, jQuery ì‚¬ìš©ê°€ëŠ¥
    console.log("custom_answer_check.js ì‹¤í–‰");

    // ì»¤ìŠ¤í…€ ì±„ì  ëŒ€ìƒ ì¶”ê°€
    window.getCustomTargets = function (page) {
        return $(page).find(".r2");
    };

    // ì»¤ìŠ¤í…€ ì •ë‹µ ì¡°ê±´
    window.customCheckCondition = function (el) {
        // ì´ê³³ì— ì²´í¬ë²„íŠ¼ì„ í´ë¦­í–ˆì„ë•Œ ì‹¤í–‰í•  ì»¤ìŠ¤í…€ ì±„ì  ë¡œì§ì„ ìž‘ì„±í•©ë‹ˆë‹¤.
        // ì²´í¬ë²„íŠ¼ í´ë¦­ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜ìž…ë‹ˆë‹¤.
        // return true ë°˜í™˜í•˜ë©´ ì •ë‹µ ì²˜ë¦¬ ë©ë‹ˆë‹¤.
        // return false ë°˜í™˜í•˜ë©´ ì˜¤ë‹µ ì²˜ë¦¬ ë©ë‹ˆë‹¤.
        // return "empty" ë°˜í™˜í•˜ë©´ ë¹„ì–´ìžˆëŠ” ê²½ìš° ì²˜ë¦¬(í’€ì´ ë…ë ¤ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ë°œìƒ)ë©ë‹ˆë‹¤.

        // ex) ìˆ«ìž ìž…ë ¥ì°½ì— ê°’ì´ 1ì´ìƒì´ë©´ ì •ë‹µ ì²˜ë¦¬, 1ì´í•˜ì´ë©´ ì˜¤ë‹µ ì²˜ë¦¬, ë¹„ì–´ìžˆìœ¼ë©´ í’€ì´ ë…ë ¤ í† ìŠ¤íŠ¸ ë©”ì‹œì§€(ê¸°ë³¸ê°’) ë°œìƒ
        // const $el = $(el); //ì±„ì  ëŒ€ìƒ ì¶”ê°€ì—ì„œ ì¶”ê°€í•œ ìš”ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        // const rule = $el.data("answerCustom"); //ì±„ì  ëŒ€ìƒ ì¶”ê°€ì—ì„œ ì¶”ê°€í•œ ìš”ì†Œì˜ data-answer-custom ì†ì„±ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
        // const val = $el.val(); //ì±„ì  ëŒ€ìƒ ì¶”ê°€ì—ì„œ ì¶”ê°€í•œ ìš”ì†Œì˜ ê°’ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.

        // // ì¡°ê±´ ì„¤ì •
        // if (val === "" || val == null) return "empty"; // ë¹„ì–´ìžˆìœ¼ë©´ empty ì²˜ë¦¬

        // const num = parseFloat(val); //ìˆ«ìžë¡œ ë³€í™˜
        // if (isNaN(num)) return "empty"; // empty ë°˜í™˜í•˜ë©´ ë¹„ì–´ìžˆëŠ” ê²½ìš° ì²˜ë¦¬ ë©ë‹ˆë‹¤.

        // if (rule === "min-1") {
        //     return num >= 1; //false ë°˜í™˜í•˜ë©´ ì˜¤ë‹µ ì²˜ë¦¬ ë©ë‹ˆë‹¤.
        // }

        const answer = el.getAttribute('data-single-answer')
        const correction = el.getAttribute('data-connection');
        console.log('answer', answer);
        console.log('correction', correction);

        return answer === correction ? true : false; //true ë°˜í™˜í•˜ë©´ ì •ë‹µ ì²˜ë¦¬ ë©ë‹ˆë‹¤.
    };

    // // ì˜¤ë‹µ íšŸìˆ˜ ì»¤ìŠ¤í…€ ë°˜ì‘
    // window.onCustomIncorrect = function (count) {
    //     console.log(count);
    //     if (count === 2) {
    //         console.log("ì˜¤ë‹µ íšŸìˆ˜ 2íšŒ");
    //     }
    // };

    // ì»¤ìŠ¤í…€ ì •ë‹µ ì²˜ë¦¬ ì½œë°± ì„ ì–¸ ë°©ë²•
    // ì •ë‹µ ì‹œ ì¶”ê°€ ë™ìž‘
    // window.onCorrectCustom = function () {
    //     alert("ðŸŽ‰ ì •ë‹µì´ì—ìš”!");
    // };

    // // ì˜¤ë‹µ ì‹œ ì¶”ê°€ ë™ìž‘
    // window.onIncorrectCustom = function () {
    //     alert("â— ë‹¤ì‹œ ìƒê°í•´ë³´ì„¸ìš”.");
    // };

    // ë‘ ë²ˆì§¸ ì˜¤ë‹µ ì‹œ
    window.onIncorrectTwiceCustom = function () {
        // alert("ðŸš¨ ì •ë‹µ ê³µê°œë©ë‹ˆë‹¤!");
        document.querySelectorAll('.r2>.small_div').forEach((div) => {
            div.click();
        });
    };

    // // ìž…ë ¥ ì•ˆ í–ˆì„ ë•Œ
    // window.onEmptyCustom = function () {
    //     alert("ðŸ‘€ ìž…ë ¥ì„ ë¨¼ì € í•´ë³´ì„¸ìš”!");
    // };

    // ë¦¬ì…‹ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰í•  ì»¤ìŠ¤í…€ í•¨ìˆ˜
    window.resetCustom = function () {
        console.log('ë¦¬ì…‹ ë²„íŠ¼ í´ë¦­');

        // wraps w1ì„ ì œì™¸í•œ wrapë“¤ ì•ˆì˜ small_divë¥¼ r2ë¡œ ë³µì›
        for (let wrap of wraps) {
            if (wrap !== w1) {
                const smallDivs = wrap.querySelectorAll('.small_div');

                smallDivs.forEach(div => {
                    r2.appendChild(div);
                });

                wrap.style.border = 'none';
            }
        }

        // data-correction ì†ì„± ì œê±°
        r2.removeAttribute('data-correction');

        // data-connection ì†ì„± ì´ˆê¸°í™”
        r2.setAttribute('data-connection', JSON.stringify([]));

        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        window.forceWatchEvaluation();
    };

    // // ì˜ˆì‹œ ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰í•  ì»¤ìŠ¤í…€ í•¨ìˆ˜
    // window.sampleCustom = function () {
    //     alert("ðŸ’¡ ì˜ˆì‹œ ë²„íŠ¼ í´ë¦­ë¨");
    // };

    //ì´ë ‡ê²Œê°€ ì—°ë™ëœ í•¨ìˆ˜ì˜ ì„ ì–¸ ë°©ë²•ìž…ë‹ˆë‹¤.
    //ë²„íŠ¼ í™œì„±í™” ë¶€ë¶„ì€ ì•„ëž˜ì™€ ê°™ì€ íŒ¨í„´ìœ¼ë¡œ ì„ ì–¸í•˜ë©´ ë©ë‹ˆë‹¤.
    const target = $(".r2");

    // 1. ê°’ ë³€ê²½ì„ ê°ì§€
    // 2. ê°’ ë³€ê²½ì‹œ ë²„íŠ¼ í™œì„±í™” ì—¬ë¶€ ê²°ì •
    // ex) ìˆ«ìž ìž…ë ¥ì°½ì— ê°’ì´ ìžˆìœ¼ë©´ ëª¨ë“  ë²„íŠ¼ í™œì„±í™”, ì—†ìœ¼ë©´ ë¹„í™œì„±í™”

    defineButtonClassRules([
        {
            selector: ".r2", //ë³€ê²½ë  ê°’ì„ ê°ì§€í•  íƒœê·¸ ì„¤ì •
            //ì•„ëž˜ ì¤‘ í•˜ë‚˜ í™œìš©
            key: "check_target", // ê³µí†µ ë²„íŠ¼ê³¼ ë˜‘ê°™ì´ ê²°ì •ë˜ëŠ” í™œì„±í™” ì—¬ë¶€ ê²°ì • í‚¤
            //key: "custom_reset_btn_active", // ë¦¬ì…‹ë²„íŠ¼ í™œì„±í™” ì—¬ë¶€ ê²°ì • í‚¤
            //key: "custom_sample_btn_active", // ì˜ˆì‹œë²„íŠ¼ í™œì„±í™” ì—¬ë¶€ ê²°ì • í‚¤
            // key: "custom_check_btn_active", // í™•ì¸ë²„íŠ¼ í™œì„±í™” ì—¬ë¶€ ê²°ì • í‚¤
            //key: "custom_submit_btn_active", // ì œì¶œë²„íŠ¼ í™œì„±í™” ì—¬ë¶€ ê²°ì • í‚¤
            test: (el) => {
                //í™œì„±í™” ì—¬ë¶€ ê²°ì • ë¡œì§ true ë°˜í™˜í•˜ë©´ ë²„íŠ¼ í™œì„±í™”, false ë°˜í™˜í•˜ë©´ ë¹„í™œì„±í™”
                //elì€ íƒ€ê²Ÿì„ ì˜ë¯¸í•˜ëŠ” ìš”ì†Œ
                //ex) ê°’ì´ ë¹„ì–´ìžˆê±°ë‚˜ nullì¸ ê²½ìš°ë¡œ ì¡°ê±´ ì„¤ì •í•œ ê²½ìš° ì˜ˆì‹œ
                // const val = $(el).val();
                // if (val == "" || val == null) {
                //     return false;
                // }
                // return true;

                const activationCondition = w2.querySelectorAll('.small_div').length !== 0;
                return activationCondition;
            },
            // setClass: [
            //     { target: ".btnReset", class: "active" },
            //     { target: ".btnCheck", class: "active" }
            // ]
        },
    ]);
    // // ë²„íŠ¼ ìƒíƒœ ë³€ê²½ í›„ ê°•ì œ í‰ê°€ ë¬¸ ì‹¤í–‰
    // window.forceWatchEvaluation();

    // // ì œì¶œ ë²„íŠ¼ í´ë¦­ ì‹œ ì»¤ìŠ¤í…€ ê²€ì¦ ë¡œì§
    // window.customValidateBeforeSubmit = function ({ hasEmpty, isSelfCheckMissing, rules }) {
    //     console.log("ðŸ” ì»¤ìŠ¤í…€ ì œì¶œ ì „ ê²€ì¦ ë¡œì§ ì‹¤í–‰ë¨");
    //     console.log("ë¹ˆ í•­ëª© ì¡´ìž¬ ì—¬ë¶€:", hasEmpty);
    //     console.log("ìžê¸° ì ê²€ ë¯¸ì„ íƒ ì—¬ë¶€:", isSelfCheckMissing);
    //     console.log("ê²€ì‚¬ ê·œì¹™:", rules);

    //     // ì¡°ê±´ì— ë”°ë¼ ì‚¬ìš©ìžì—ê²Œ ì•Œë¦¼ í‘œì‹œ
    //     if (hasEmpty) {
    //         alert("âš ï¸ ë¹ˆ í•­ëª©ì´ ì¡´ìž¬í•©ë‹ˆë‹¤. ì œì¶œì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.");
    //         return false; // ê¸°ë³¸ í† ìŠ¤íŠ¸ ë°©ì§€
    //     }

    //     return true; // ê¸°ë³¸ ë¡œì§ ê³„ì† ì‹¤í–‰
    // };
});








const createBigDiv = () => {
    const div = document.createElement('div');
    div.classList.add('big_div');
    div.textContent = '1';
    r1.appendChild(div);
};

const createSmallDiv = () => {
    const div = document.createElement('div');
    div.classList.add('small_div');
    div.textContent = '0.1';
    r1.appendChild(div);
}

const createR2SmallDiv = (parent) => {
    const div = document.createElement('div');
    div.classList.add('small_div');
    div.textContent = '0.1';

    div.addEventListener('click', () => {
        div.classList.toggle('active');
        updateWrappers();
    });

    parent.appendChild(div);
}

const updateWrappers = () => {
    const activeDivs = r2.querySelectorAll('.small_div.active')
    if (activeDivs.length === 9) {
        for (let wrap of wraps) {
            if (wrap.querySelectorAll('.small_div').length < 9) {
                [...activeDivs].forEach(div => {
                    wrap.appendChild(div);
                    div.classList.remove('active');
                });

                // border í™œì„±í™”
                if (wrap.classList.contains('w1')) { } else {
                    wrap.style.border = '3px solid #3B71FE';
                }
                moved = true;
                break;
            }
        }
    }

    // small_divê°€ 9ê°œì¸ wrapë“¤ì˜ í´ëž˜ìŠ¤ë¥¼ ëª¨ì€ë‹¤
    const fullWraps = wraps.filter(wrap => wrap.querySelectorAll('.small_div').length === 9)
    // ê°€ë“ì°¬ wrap ê°œìˆ˜ë¥¼ ì •ë‹µê³¼ ì—°ê²°
    r2.setAttribute('data-connection', JSON.stringify([fullWraps.length]));
    // ë²„íŠ¼ ìƒíƒœ ë³€ê²½ í›„ ê°•ì œ í‰ê°€ ë¬¸ ì‹¤í–‰
    window.forceWatchEvaluation();
}

const setting = () => {
    boxContainer = document.querySelector('.box_container');
    r1 = boxContainer.querySelector('.r1');
    r2 = boxContainer.querySelector('.r2');
    count = r2.querySelectorAll('.small_div');
    w1 = r2.querySelector('.wrap.w1');
    w2 = r2.querySelector('.wrap.w2');
    w3 = r2.querySelector('.wrap.w3');
    w4 = r2.querySelector('.wrap.w4');
    wraps = [w1, w2, w3, w4];

    createBigDiv();
    createBigDiv();
    createBigDiv();
    createSmallDiv();
    createSmallDiv();
    createSmallDiv();
    createSmallDiv();
    createSmallDiv();
    createSmallDiv();



    for (let i = 0; i < 36 - 9; i++) {
        createR2SmallDiv(r2);
    }

    for (let i = 0; i < 9; i++) {
        createR2SmallDiv(w1);
    }
};