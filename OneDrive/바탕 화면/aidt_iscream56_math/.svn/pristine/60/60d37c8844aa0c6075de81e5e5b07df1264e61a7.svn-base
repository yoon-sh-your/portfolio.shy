document.addEventListener("DOMContentLoaded", function () {
  const connectionToGifIndex = {
    "s1-e1": "02",
    "s2-e2": "01",
    "s3-e3": "03",
    "s4-e4": "04",
    "s5-e5": "05",
    "s6-e6": "06",
    "s7-e8": "07",
    "s8-e7": "08",
    "s9-e10": "09",
    "s10-e9": "10"
  };
  

  document.querySelectorAll(".connect_wrap").forEach((wrap) => {
    const points = wrap.querySelectorAll(".connect_point");
    const figure = wrap.closest(".figure");

    let selectedFirst = null;
    let isConnecting = false;

    points.forEach((point) => {
      point.addEventListener("click", () => {
        if (isConnecting) return;

        const currentId = point.getAttribute("data-id");

        if (!selectedFirst) {
          // Ï≤´ Î≤àÏß∏ Ï†ê ÏÑ†ÌÉù
          selectedFirst = currentId;
        } else {
          const secondId = currentId;

          // Í∞ôÏùÄ Ï†êÏùÑ Îëê Î≤à ÌÅ¥Î¶≠Ìïú Í≤ΩÏö∞ Î¨¥Ïãú
          if (selectedFirst === secondId) {
            selectedFirst = null;
            return;
          }

          isConnecting = true;

          // Îëê Ï†ê Ï°∞Ìï©ÏùÑ ÏñëÎ∞©Ìñ•ÏúºÎ°ú ÌôïÏù∏
          const key1 = `${selectedFirst}-${secondId}`;
          const key2 = `${secondId}-${selectedFirst}`;
          const gifIndex = connectionToGifIndex[key1] || connectionToGifIndex[key2];

          if (gifIndex) {
            showFoldingAnimation(figure, gifIndex);
          }

          selectedFirst = null;
          setTimeout(() => {
            isConnecting = false;
          }, 100);
        }
      });
    });
  });
  // ‚úÖ ÎìúÎûòÍ∑∏ Ïó∞Í≤∞ Í∞êÏßÄ Î∞è gif Ï≤òÎ¶¨ Ï∂îÍ∞Ä
  const observer = new MutationObserver((mutationsList) => {
    for (const mutation of mutationsList) {
      if (mutation.type === "attributes" && mutation.attributeName === "data-connections") {
        const wrap = mutation.target;
        const figure = wrap.closest(".figure");
        const newValue = wrap.getAttribute("data-connections");

        if (!newValue) return;

        try {
          const connections = JSON.parse(newValue);

          connections.forEach(pair => {
            const [startId, endId] = pair;
            const key1 = `${startId}-${endId}`;
            const key2 = `${endId}-${startId}`;
            const gifIndex = connectionToGifIndex[key1] || connectionToGifIndex[key2];

            if (gifIndex) {
              showFoldingAnimation(figure, gifIndex);
            }
          });
        } catch (err) {
          console.warn("‚ùå data-connections ÌååÏã± Ïã§Ìå®:", err);
        }
      }
    }
  });

  document.querySelectorAll(".connect_wrap").forEach(wrap => {
    observer.observe(wrap, { attributes: true });
  });

  // ‚úÖ gif ÌëúÏãú Ìï®Ïàò (Í≥µÌÜµ ÏÇ¨Ïö©)
  function showFoldingAnimation(figureElement, gifIndex) {
    const fileName = `0004_gif_${gifIndex}.gif`;
    const gifPath = `../../common_contents/img/EMA523_04_SU/${fileName}`;

    const existingGif = figureElement.querySelector(".folding_gif");
    if (existingGif) existingGif.remove();

    const gif = document.createElement("img");
    gif.src = gifPath;
    gif.className = `folding_gif gif${gifIndex}`;
    gif.style.display = "block";

    const svg = figureElement.querySelector("svg");
    if (svg) svg.style.opacity = "0";

    figureElement.appendChild(gif);

    setTimeout(() => {
      gif.style.display = "none";
      if (svg) svg.style.opacity = "1";
    }, 3000);
  }

  // ‚úÖ ÌÅ¥Î¶≠ Î∞è ÎìúÎûòÍ∑∏ Ïãú Ïó∞Í≤∞ÏÑ†ÏùÄ Ï†àÎåÄ ÏÇ¨ÎùºÏßÄÏßÄ ÏïäÏúºÎ©∞, Ìï≠ÏÉÅ gif Î™®ÏÖòÏùÄ Ïã§ÌñâÎê®

  window.onCorrectCustom = function () {
    console.log("üî• onCorrectCustom Ïã§ÌñâÎê®");
    setTimeout(() => {
      const wraps = document.querySelectorAll(".connect_wrap.correct, .connect_wrap_click.correct");
      console.log("‚úÖ correct ÎåÄÏÉÅ Ïàò:", wraps.length);
  
      wraps.forEach(wrap => {
        const figure = wrap.closest(".figure");
        if (!figure) return;
  
        // Í∏∞Ï°¥ gif Ï†úÍ±∞
        try {
          figure.querySelectorAll(".folding_gif").forEach(el => el.remove());
        } catch (e) {
          console.warn("‚ùå folding_gif Ï¥àÍ∏∞Ìôî Ï§ë ÏòàÏô∏ Î∞úÏÉù:", e);
        }
        const answerRaw = wrap.getAttribute("data-sample-line");
        const userConnectionsRaw = wrap.getAttribute("data-connections");

        if (!answerRaw || !userConnectionsRaw) return;

        let answer, userConnections;
        try {
          if (!answerRaw || !userConnectionsRaw) throw new Error("ÏÜçÏÑ±Ïù¥ ÎπÑÏñ¥ÏûàÏùå");

          // JSON ÌååÏã±
          answer = JSON.parse(answerRaw);
          userConnections = JSON.parse(userConnectionsRaw);

          if (!Array.isArray(answer) || !Array.isArray(userConnections)) {
            throw new Error("Î∞∞Ïó¥Ïù¥ ÏïÑÎãò");
          }
        } catch (err) {
          console.warn("‚ùå answer ÎòêÎäî connections ÌååÏã± Ïã§Ìå®:", err, {
            answerRaw,
            userConnectionsRaw
          });
          return;
        } 
        // ‚úÖ Î∞∞Ïó¥ ÎÇ¥Ïö© ÎπÑÍµê (ÏàúÏÑú ÏÉÅÍ¥Ä ÏóÜÏù¥)
        const normalize = arr => arr.map(pair => pair.sort()).sort();
        const isEqual = JSON.stringify(normalize(answer)) === JSON.stringify(normalize(userConnections));

        if (isEqual) {
          userConnections.forEach(pair => {
            const [startId, endId] = pair;
            const key1 = `${startId}-${endId}`;
            const key2 = `${endId}-${startId}`;
            const gifIndex = connectionToGifIndex[key1] || connectionToGifIndex[key2];
            if (!gifIndex) return;

            const fileName = `0004_gif_${gifIndex}.gif`;
            const gifPath = `../../common_contents/img/EMA523_04_SU/${fileName}`;
            
            const existingGif = figure.querySelector(`.folding_gif.gif${gifIndex}`);
            if (existingGif) {
              existingGif.style.display = "block"; // Ïà®Í≤®Ï†∏ ÏûàÏúºÎ©¥ Îã§Ïãú Î≥¥Ïù¥Í≤å
            } else {
              const gif = document.createElement("img");
              gif.src = `${gifPath}?t=${Date.now()}`;
              gif.className = `folding_gif gif${gifIndex}`;
              gif.style.display = "block";
              const svg = figure.querySelector("svg");
              if (svg) svg.style.opacity = "0";
              figure.appendChild(gif);
            }
          });
        }
  
        // sample-line Í∏∞Ï§ÄÏúºÎ°ú Ïó∞Í≤∞Îêú gifIndexÎßå Ï∂îÏ∂úÌïòÏó¨ Î™®ÏÖò ÌëúÏãú
        figure.querySelectorAll("line[data-sample-line]").forEach(line => {
          const startId = line.getAttribute("data-from");
          const endId = line.getAttribute("data-to");
          const key1 = `${startId}-${endId}`;
          const key2 = `${endId}-${startId}`;
          const gifIndex = connectionToGifIndex[key1] || connectionToGifIndex[key2];
  
          console.log("üîç startId:", startId, "endId:", endId, "gifIndex:", gifIndex);
          if (!gifIndex) return;
  
          // GIF ÌååÏùºÎ™ÖÍ≥º Í≤ΩÎ°ú Ïò¨Î∞îÎ•¥Í≤å Ï°∞Ìï©
          const fileName = `0004_gif_${gifIndex}.gif`;
          const gifPath = `../../common_contents/img/EMA523_04_SU/${fileName}`;
  
          const gif = document.createElement("img");
          gif.src = `${gifPath}?t=${Date.now()}`;  // Ï∫êÏãú Î∞©ÏßÄÏö© ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï∂îÍ∞Ä
          gif.className = `folding_gif gif${gifIndex}`;
          gif.style.display = "block";
  
          const svg = figure.querySelector("svg");
          if (svg) svg.style.opacity = "0";
  
          figure.appendChild(gif);
        });
      });
    }, 50);
  };
  

window.resetCustom = function () {
  //alert("üîÑ Î¶¨ÏÖã Î≤ÑÌäº ÌÅ¥Î¶≠Îê®");

  const currentPageId = document.querySelector('#app_wrap')?.getAttribute('data-current-page');
  if (!currentPageId) return;

  const currentPage = document.querySelector(`.page.${currentPageId}`);
  if (!currentPage) return;

  currentPage.querySelectorAll(".folding_gif").forEach(el => el.remove());
  currentPage.querySelectorAll("svg").forEach(svg => svg.style.opacity = "1");

  $(currentPage).find(".custom_check_target").val("");
};


  window.onCustomIncorrect = function (count) { 
    console.log(count);
    if (count === 2) {
      setTimeout(() => {
        document.querySelectorAll(".connect_wrap.correct, .connect_wrap_click.correct").forEach(wrap => {
          const figure = wrap.closest(".figure");
          if (!figure) return;
  
          try {
            figure.querySelectorAll(".folding_gif").forEach(el => el.remove());
          } catch (e) {
            console.warn("‚ùå folding_gif Ï¥àÍ∏∞Ìôî Ï§ë ÏòàÏô∏ Î∞úÏÉù:", e);
          }
  
          const connectionsRaw = wrap.getAttribute("data-connections");
          if (!connectionsRaw || connectionsRaw === "[]") return;
  
          let connections;
          try {
            connections = JSON.parse(connectionsRaw);
            if (!Array.isArray(connections)) throw new Error("connections is not an array");
          } catch (err) {
            // console.warn("‚ùå data-connections ÌååÏã± Ïã§Ìå® ÎòêÎäî ÌòïÏãù Ïò§Î•ò:", err);
            return;
          }
  
          connections.forEach(pair => {
            if (!Array.isArray(pair) || pair.length !== 2) return;
  
            const [startId, endId] = pair;
            const key1 = `${startId}-${endId}`;
            const key2 = `${endId}-${startId}`;
            const gifIndex = connectionToGifIndex[key1] || connectionToGifIndex[key2];
            if (!gifIndex) return;
  
            // ‚úÖ gifÎäî Ïú†ÏßÄÌïòÍ≥† svgÎßå Ïà®ÍπÄ Ï≤òÎ¶¨
            try {
              figure.querySelectorAll(".folding_gif").forEach(el => el.remove());
            } catch (e) {
              console.warn("‚ùå gif Ï¥àÍ∏∞Ìôî Ïã§Ìå®:", e);
            }
  
            const fileName = `0004_gif_${gifIndex}.gif`;
            const gifPath = `../../common_contents/img/EMA523_04_SU/${fileName}`;
  
            const gif = document.createElement("img");
            gif.src = `${gifPath}?t=${Date.now()}`;
            gif.className = `folding_gif gif${gifIndex}`;
            gif.style.display = "block";
  
            const svg = figure.querySelector("svg");
            if (svg) svg.style.opacity = "0";
  
            figure.appendChild(gif);
  
            // ‚úÖ gifÎäî Ïú†ÏßÄ, svgÎäî Í≥ÑÏÜç Ïà®ÍπÄ ÏÉÅÌÉú Ïú†ÏßÄ
          });
        });
      }, 50);
    }
  };
});

